name: Auto-merge validated PRs

on:
  workflow_run:
    workflows: ["Validate Control Submission"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_MERGE_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.payload.workflow_run.head_repository.owner.login}:${context.payload.workflow_run.head_branch}`
            });
            if (prs.length > 0) {
              return prs[0].number;
            }
            return null;
          result-encoding: string

      - name: Merge PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_MERGE_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.result }},
              merge_method: 'squash'
            });
            console.log(`Merged PR #${{ steps.pr.outputs.result }}`);
